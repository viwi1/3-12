<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>3:12 Utdelningskalkylator</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 650px;
      margin: auto;
      padding: 20px;
    }
    .slider-container {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }
    .slider-value {
      width: 60px;
      margin-left: 10px;
      font-weight: bold;
    }
    .box {
      border: 1px solid #ccc;
      padding: 15px;
      margin-top: 10px;
      background: #f9f9f9;
    }
    .result-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 5px;
    }
    .checkbox-container {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    label {
      display: block;
      margin-top: 10px;
    }
    /* Modal (popup) */
    .modal {
      display: none;            
      position: fixed; 
      z-index: 999; 
      left: 0; 
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
      background-color: #fff;
      margin: 8% auto; 
      padding: 20px;
      border: 1px solid #888;
      width: 90%; 
      max-width: 600px; 
      border-radius: 4px;
      text-align: left;
      position: relative;
      max-height: 80vh; /* Skrollbar om det blir f√∂r h√∂gt */
      overflow-y: auto;
    }
    .close {
      color: #aaa;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
      position: absolute;
      top: 10px; 
      right: 15px; 
    }
    .close:hover {
      color: #000;
    }
  </style>
</head>
<body>

  <h3>Kapital efter f√∂rs√§ljning och utdelning per √•r</h3>

  <!-- 1) V√§rde p√• bolaget -->
  <p><strong>Nuvarande v√§rde p√• bolaget:</strong> <span id="nuvarde"></span></p>
  <div class="checkbox-container">
    <input type="checkbox" id="daligtNuvarde" onchange="uppdateraNuvarde()" />
    <label for="daligtNuvarde">3 000 000 kr</label>
  </div>

  <!-- 2) Multipel -->
  <div class="slider-container">
    <label for="multipel">Multipel:</label>
    <input type="range" id="multipel" min="1.1" max="4" step="0.1" value="1.5" oninput="uppdateraBer√§kningar()" />
    <!-- Visar multiplikatorn med en decimal -->
    <span class="slider-value" id="multipelValue">1.5</span>
  </div>

  <!-- 3) Val av att betala husl√•n -->
  <div class="checkbox-container">
    <input type="checkbox" id="betalaHuslan" onchange="uppdateraBer√§kningar()" />
    <label for="betalaHuslan">üè° Betala av husl√•net direkt vid exit</label>
  </div>

  <!-- 4) Exit-belopp (resultat) -->
  <div class="result" id="resultF√∂rs√§ljning"></div>

  <!-- 5) Rutan f√∂r aktieutdelning, inkl klickbar IBB -->
  <div class="result" id="resultAktieutdelning">
    <div class="box">
      <p class="result-title">Aktieutdelning</p>

      <!-- Slider f√∂r avkastning -->
      <div class="slider-container">
        <label for="avkastning">Avkastning (% per √•r):</label>
        <input
          type="range"
          id="avkastning"
          min="1"
          max="30"
          step="1"
          value="10"
          oninput="uppdateraBer√§kningar()"
        />
        <span class="slider-value" id="avkastningValue">10%</span>
      </div>

      <!-- Klickbar IBB-belopp -->
      <p>
        <strong>Aktuellt IBB:</strong>
        <span 
          id="ibbLabel"
          style="cursor:pointer; text-decoration:underline;"
          onclick="openModalIBB()"
        ></span>
      </p>

      <p>Brutto: <span id="brutto"></span></p>
      <p>
        Inom gr√§nsv√§rde (20% skatt):
        <span id="inomGransvardeBrutto"></span>
        ‚Üí Netto: <span id="inomGransvardeNetto"></span>
      </p>
      <p>
        √ñver gr√§nsv√§rde (50% skatt):
        <span id="overGransvardeBrutto"></span>
        ‚Üí Netto: <span id="overGransvardeNetto"></span>
      </p>
      <p>
        <strong>Totalt netto utdelning:</strong>
        <span id="totaltNetto"></span>
      </p>
      <div id="utdelningHuslan" style="display:none;">
        <p>
          <strong>Utan att betala husl√•n:</strong>
          <span id="utdelningOjust"></span>
        </p>
        <p>
          <strong>Skillnad:</strong>
          <span id="utdelningSkillnad"></span>
        </p>
      </div>
    </div>
  </div>

  <!-- 6) Modal f√∂r EGET 3:12-gr√§nsv√§rde -->
  <div id="myModal312" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal312()">&times;</span>
      <h3>√Ñndra eget 3:12-gr√§nsv√§rde</h3>
      <label for="popupGransvarde312">Ange √∂nskat bruttobelopp f√∂r 20% skatt:</label>
      <input 
        type="number" 
        id="popupGransvarde312" 
        oninput="updateUserGransvarde312()" 
        style="width: 200px;" 
      />
      <button style="margin-top:10px;" onclick="closeModal312()">OK</button>
    </div>
  </div>

  <!-- 7) Modal f√∂r husl√•net -->
  <div id="myModalHuslan" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModalHuslan()">&times;</span>
      <h3>St√§ll in ditt husl√•n</h3>
      <label for="popupHuslan">Nuvarande husl√•n (kr):</label>
      <input 
        type="number"
        id="popupHuslan"
        oninput="updateHuslan()"
        style="width: 200px;"
      />
      <button style="margin-top:10px;" onclick="closeModalHuslan()">OK</button>
    </div>
  </div>

  <!-- 8) Modal f√∂r IBB -->
  <div id="myModalIBB" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModalIBB()">&times;</span>
      <h3>St√§ll in IBB (Inkomstbasbelopp)</h3>
      <label for="popupIBB">Aktuellt IBB (kr):</label>
      <input 
        type="number"
        id="popupIBB"
        oninput="updateIBB()"
        style="width: 200px;"
      />
      <button style="margin-top:10px;" onclick="closeModalIBB()">OK</button>
    </div>
  </div>

  <script>
    // Globala variabler
    let userGransvarde312 = 684166; 
    let huslan = 2000000;          
    let normaltNuvarde = 6855837;
    let daligtNuvarde = 3000000;
    let nuvarde = normaltNuvarde;
    let ibb = 80600; // standard

    // Format: avrunda heltal + svensk tusentalsavgr√§nsare
    function formatNumber(num) {
      return Math.round(num).toLocaleString("sv-SE") + " kr";
    }

    // ====== Modal husl√•n ======
    function openModalHuslan() {
      document.getElementById("popupHuslan").value = huslan;
      document.getElementById("myModalHuslan").style.display = "block";
    }
    function closeModalHuslan() {
      document.getElementById("myModalHuslan").style.display = "none";
    }
    function updateHuslan() {
      let val = parseFloat(document.getElementById("popupHuslan").value);
      if (isNaN(val)) val = 2000000;
      huslan = val;
      uppdateraBer√§kningar();
    }

    // ====== Modal 3:12 ======
    function openModal312() {
      document.getElementById("popupGransvarde312").value = userGransvarde312;
      document.getElementById("myModal312").style.display = "block";
    }
    function closeModal312() {
      document.getElementById("myModal312").style.display = "none";
    }
    function updateUserGransvarde312() {
      let val = parseFloat(document.getElementById("popupGransvarde312").value);
      if (isNaN(val)) val = 684166; 
      userGransvarde312 = val;
      uppdateraBer√§kningar();
    }

    // ====== Modal IBB ======
    function openModalIBB() {
      document.getElementById("popupIBB").value = ibb;
      document.getElementById("myModalIBB").style.display = "block";
    }
    function closeModalIBB() {
      document.getElementById("myModalIBB").style.display = "none";
    }
    function updateIBB() {
      let val = parseFloat(document.getElementById("popupIBB").value);
      if (isNaN(val)) val = 80600;
      ibb = val;
      uppdateraBer√§kningar();
    }

    // ====== Nuvarande v√§rde ======
    function uppdateraNuvarde() {
      let checkbox = document.getElementById("daligtNuvarde");
      nuvarde = checkbox.checked ? daligtNuvarde : normaltNuvarde;
      uppdateraBer√§kningar();
    }

    // ====== Utdelningsber√§kning ======
    function ber√§knaUtdelning(totalAvkastning, gransvarde, skattL√•g, skattH√∂g) {
      let bruttoL√•g = Math.min(totalAvkastning, gransvarde);
      let bruttoH√∂g = totalAvkastning > gransvarde ? totalAvkastning - gransvarde : 0;
      let nettoL√•g = bruttoL√•g * (1 - skattL√•g);
      let nettoH√∂g = bruttoH√∂g * (1 - skattH√∂g);
      let totalNetto = nettoL√•g + nettoH√∂g;
      return { bruttoL√•g, bruttoH√∂g, nettoL√•g, nettoH√∂g, totalNetto };
    }

    // ====== Huvudkalkyl ======
    function uppdateraBer√§kningar() {
      // Multipel
      let multipel = parseFloat(document.getElementById("multipel").value);
      document.getElementById("multipelValue").textContent = multipel.toFixed(1);

      // Avkastning
      let avkastningProcent = parseInt(document.getElementById("avkastning").value, 10);
      let avkastning = avkastningProcent / 100;
      document.getElementById("avkastningValue").textContent = avkastningProcent + "%";

      // S√§tt rubrik 
      document.getElementById("nuvarde").textContent = formatNumber(nuvarde);

      let betalaHuslan = document.getElementById("betalaHuslan").checked;
      let f√∂rs√§ljningspris = nuvarde * multipel;
      let exitKapital = f√∂rs√§ljningspris;

      let skattL√•g = 0.20;
      let skattH√∂g = 0.50;

      // Ber√§kna hushantering
      let nettolag = userGransvarde312 * (1 - skattL√•g);
      let l√•nebehovEfterL√•gSkatt = huslan - nettolag;
      let bruttoH√∂gBehov = l√•nebehovEfterL√•gSkatt / (1 - skattH√∂g);
      let totaltBruttoF√∂rL√•n = userGransvarde312 + bruttoH√∂gBehov;

      if (betalaHuslan) {
        exitKapital -= totaltBruttoF√∂rL√•n;
      }

      // Bygg HTML f√∂r exit
      let htmlExit = `<div class="box">`;
      if (betalaHuslan) {
        htmlExit += `
          <p class="result-title">Exitbelopp efter husl√•nsbetalning üè°</p>
          <p><strong>${formatNumber(exitKapital)}</strong></p>

          <!-- H√§r √§r det klickbara husl√•n -->
          <p>
            <strong>Aktuellt husl√•n:</strong>
            <span
              style="cursor:pointer; text-decoration:underline;"
              onclick="openModalHuslan()"
            >
              ${formatNumber(huslan)}
            </span>
          </p>

          <p><strong>Utr√§kning av husl√•nsbetalning:</strong></p>
          <p>Bruttobelopp som kr√§vs: ${formatNumber(totaltBruttoF√∂rL√•n)}</p>
          <p>
            - Eget 3:12-gr√§nsv√§rde (20% skatt):
            <span
              style="color:blue; text-decoration:underline; cursor:pointer;"
              onclick="openModal312()"
            >
              ${formatNumber(userGransvarde312)}
            </span>
            ‚Üí Netto: ${formatNumber(nettolag)}
          </p>
          <p>
            - Resterande belopp (50% skatt):
            ${formatNumber(bruttoH√∂gBehov)} ‚Üí Netto:
            ${formatNumber(l√•nebehovEfterL√•gSkatt)}
          </p>
        `;
      } else {
        htmlExit += `
          <p class="result-title">Exitbelopp</p>
          <p><strong>${formatNumber(exitKapital)}</strong></p>
        `;
      }
      htmlExit += `</div>`;

      document.getElementById("resultF√∂rs√§ljning").innerHTML = htmlExit;

      // Gr√§nsv√§rde f√∂r utdelning
      let gransvarde = ibb * 2.75;

      // Utdelningsber√§kning
      let totalAvkastningJust = exitKapital * avkastning;
      let totalAvkastningOjust = f√∂rs√§ljningspris * avkastning;
      let utdelningJust = ber√§knaUtdelning(totalAvkastningJust, gransvarde, skattL√•g, skattH√∂g);
      let utdelningOjust = ber√§knaUtdelning(totalAvkastningOjust, gransvarde, skattL√•g, skattH√∂g);
      let skillnad = utdelningOjust.totalNetto - utdelningJust.totalNetto;

      // Fyll i utdelningsrutan
      document.getElementById("brutto").textContent = formatNumber(totalAvkastningJust);
      document.getElementById("inomGransvardeBrutto").textContent = formatNumber(utdelningJust.bruttoL√•g);
      document.getElementById("inomGransvardeNetto").textContent = formatNumber(utdelningJust.nettoL√•g);
      document.getElementById("overGransvardeBrutto").textContent = formatNumber(utdelningJust.bruttoH√∂g);
      document.getElementById("overGransvardeNetto").textContent = formatNumber(utdelningJust.nettoH√∂g);
      document.getElementById("totaltNetto").textContent = formatNumber(utdelningJust.totalNetto);

      let utdHuslanDiv = document.getElementById("utdelningHuslan");
      if (betalaHuslan) {
        utdHuslanDiv.style.display = "block";
        document.getElementById("utdelningOjust").textContent = formatNumber(utdelningOjust.totalNetto);
        document.getElementById("utdelningSkillnad").textContent = formatNumber(skillnad);
      } else {
        utdHuslanDiv.style.display = "none";
      }

      // S√§tt text f√∂r klickbart IBB
      document.getElementById("ibbLabel").textContent = formatNumber(ibb);
    }

    // Sidstart
    window.onload = function() {
      uppdateraBer√§kningar();
    };
  </script>
</body>
</html>
