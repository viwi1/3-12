<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <title>3:12 Utdelningskalkylator ‚Äì Fungerande Exitruta & Popups</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 650px;
      margin: 20px auto;
      padding: 10px;
    }
    .slider-container {
      display: flex; 
      align-items: center; 
      margin-bottom: 10px;
    }
    .slider-value {
      width: 60px; 
      margin-left: 10px; 
      font-weight: bold;
    }
    .checkbox-container {
      display: flex; 
      align-items: center; 
      gap: 10px; 
      margin-bottom: 10px;
    }
    .box {
      border: 1px solid #ccc;
      padding: 15px; 
      margin-top: 10px; 
      background: #f9f9f9;
    }
    .result-title {
      font-size: 18px; 
      font-weight: bold;
      margin-bottom: 5px;
    }
    .link-like {
      text-decoration: underline; 
      color: blue; 
      cursor: pointer;
      font-weight: bold;
    }
    /* Overlay + popup (mindre padding) */
    .overlay {
      display: none;
      position: fixed; 
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: transparent; 
      z-index: 999;
    }
    .popup {
      position: absolute; 
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 8px;
      width: 280px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    .closePopup {
      float: right; 
      cursor: pointer; 
      font-weight: bold; 
      margin-left: 8px; 
      color: #666;
    }
    .closePopup:hover { 
      color: #000;
    }
  </style>
</head>
<body>

<h3>Kapital efter f√∂rs√§ljning och utdelning per √•r</h3>

<!-- Nuvarande v√§rde -->
<p><strong>Nuvarande v√§rde p√• bolaget:</strong> <span id="nuvarde"></span></p>
<div class="checkbox-container">
  <input type="checkbox" id="daligtNuvarde" onchange="uppdateraNuvarde()">
  <label for="daligtNuvarde">3 000 000 kr</label>
</div>

<!-- Multipel -->
<div class="slider-container">
  <label for="multipel">Multipel:</label>
  <input 
    type="range" 
    id="multipel" 
    min="1.1" max="4" step="0.1"
    value="1.5"
    oninput="uppdateraBer√§kningar()"
  >
  <span class="slider-value" id="multipelValue">1.5</span>
</div>

<!-- Checkbox husl√•n -->
<div class="checkbox-container">
  <input type="checkbox" id="betalaHuslan" onchange="uppdateraBer√§kningar()">
  <label for="betalaHuslan">üè° Betala av husl√•net direkt vid exit</label>
</div>

<!-- Exitruta -->
<div id="resultF√∂rs√§ljning"></div>

<!-- Utdelning -->
<div id="resultAktieutdelning">
  <div class="box">
    <p class="result-title">Aktieutdelning</p>
    <div class="slider-container">
      <label for="avkastning">Avkastning (% per √•r):</label>
      <input 
        type="range" 
        id="avkastning" 
        min="1" max="30" step="1"
        value="10"
        oninput="uppdateraBer√§kningar()"
      >
      <span class="slider-value" id="avkastningValue">10%</span>
    </div>
    <p>Brutto: <span id="brutto"></span></p>
    <p>
      Inom gr√§nsv√§rde (20% skatt): 
      <span class="link-like" id="inomGransvardeBrutto" onclick="openOverlayIBB()"></span>
      ‚Üí Netto: <span id="inomGransvardeNetto"></span>
    </p>
    <p>
      √ñver gr√§nsv√§rde (50% skatt): 
      <span id="overGransvardeBrutto"></span>
      ‚Üí Netto: <span id="overGransvardeNetto"></span>
    </p>
    <p>
      <strong>Totalt netto utdelning:</strong>
      <span id="totaltNetto"></span>
    </p>
    <div id="utdelningHuslan" style="display:none;">
      <p><strong>Utan att betala husl√•n:</strong> <span id="utdelningOjust"></span></p>
      <p><strong>Skillnad:</strong> <span id="utdelningSkillnad"></span></p>
    </div>
  </div>
</div>

<!-- Popup Husl√•n -->
<div class="overlay" id="overlayHuslan" onclick="closeOverlayHuslan()">
  <div class="popup" onclick="event.stopPropagation()">
    <span class="closePopup" onclick="closeOverlayHuslan()">√ó</span>
    <h4>Husl√•n</h4>
    <input 
      type="text"
      id="huslanInput" 
      style="width:120px;"
      onblur="formatHuslanBlur(event)"
    >
    <p>H√§r √§r lite random text du kan √§ndra senare om du vill.</p>
  </div>
</div>

<!-- Popup 3:12 -->
<div class="overlay" id="overlay312" onclick="closeOverlay312()">
  <div class="popup" onclick="event.stopPropagation()">
    <span class="closePopup" onclick="closeOverlay312()">√ó</span>
    <h4>Eget 3:12-gr√§nsv√§rde</h4>
    <input 
      type="number"
      id="gransvardeInput"
      style="width:120px;"
      oninput="updateUserGransvarde312()"
    >
    <p>Slumpad text h√§r som du kan byta ut n√§r du vill.</p>
  </div>
</div>

<!-- Popup IBB -->
<div class="overlay" id="overlayIBB" onclick="closeOverlayIBB()">
  <div class="popup" onclick="event.stopPropagation()">
    <span class="closePopup" onclick="closeOverlayIBB()">√ó</span>
    <h4>IBB</h4>
    <input 
      type="number"
      id="ibbInput"
      style="width:120px;"
      oninput="updateIBB()"
    >
    <p>Ytterligare text om IBB, √§ndra fritt.</p>
  </div>
</div>

<script>
  /* =========== 0) formateringsfunktion =========== */
  function formatNumber(num) {
    return Math.round(num).toLocaleString("sv-SE") + " kr";
  }

  /* ======== 1) Globala variabler ======== */
  let normaltNuvarde = 6855837;
  let daligtNuvarde = 3000000;
  let nuvarde = normaltNuvarde;

  let huslan = 2085300;           // Default husl√•n
  let userGransvarde312 = 684166; // Eget 3:12
  let ibb = 80600;                // Inkomstbasbelopp

  /* ======== 2) On page load ======== */
  window.onload = function() {
    document.getElementById("nuvarde").textContent = formatNumber(nuvarde);
    uppdateraBer√§kningar();
  };

  /* ======== 3) Popup: Husl√•n ======== */
  function openOverlayHuslan() {
    document.getElementById("overlayHuslan").style.display = "block";
    // Visa i tusentalsformat
    document.getElementById("huslanInput").value = huslan.toLocaleString("sv-SE");
  }
  function closeOverlayHuslan() {
    document.getElementById("overlayHuslan").style.display = "none";
  }
  function formatHuslanBlur(evt) {
    let str = evt.target.value;
    let raw = str.replace(/[^\d]/g, "");
    let val = parseInt(raw, 10) || 0;
    evt.target.value = val.toLocaleString("sv-SE");
    huslan = val;
    uppdateraBer√§kningar();
  }

  /* ======== 4) Popup: 3:12 ======== */
  function openOverlay312() {
    document.getElementById("overlay312").style.display = "block";
    document.getElementById("gransvardeInput").value = userGransvarde312;
  }
  function closeOverlay312() {
    document.getElementById("overlay312").style.display = "none";
  }
  function updateUserGransvarde312() {
    let val = parseFloat(document.getElementById("gransvardeInput").value);
    if(isNaN(val)) val = 684166;
    userGransvarde312 = val;
    uppdateraBer√§kningar();
  }

  /* ======== 5) Popup: IBB ======== */
  function openOverlayIBB() {
    document.getElementById("overlayIBB").style.display = "block";
    document.getElementById("ibbInput").value = ibb;
  }
  function closeOverlayIBB() {
    document.getElementById("overlayIBB").style.display = "none";
  }
  function updateIBB() {
    let val = parseFloat(document.getElementById("ibbInput").value);
    if(isNaN(val)) val = 80600;
    ibb = val;
    uppdateraBer√§kningar();
  }

  /* ======== 6) Byta nuv√§rde ======== */
  function uppdateraNuvarde() {
    nuvarde = document.getElementById("daligtNuvarde").checked ? daligtNuvarde : normaltNuvarde;
    document.getElementById("nuvarde").textContent = formatNumber(nuvarde);
    uppdateraBer√§kningar();
  }

  /* ======== 7) Ber√§kning av utdelning ======== */
  function ber√§knaUtdelning(totalAvkastning, gransvarde, skattL√•g, skattH√∂g) {
    let bruttoL√•g = Math.min(totalAvkastning, gransvarde);
    let bruttoH√∂g = (totalAvkastning > gransvarde) ? (totalAvkastning - gransvarde) : 0;
    let nettoL√•g = bruttoL√•g * (1 - skattL√•g);
    let nettoH√∂g = bruttoH√∂g * (1 - skattH√∂g);
    return { 
      bruttoL√•g, bruttoH√∂g, nettoL√•g, nettoH√∂g, totalNetto: nettoL√•g + nettoH√∂g 
    };
  }

  /* ======== 8) Huvudkalkyl ======== */
  function uppdateraBer√§kningar() {
    let multipel = parseFloat(document.getElementById("multipel").value);
    document.getElementById("multipelValue").textContent = multipel.toFixed(1);

    let betalaHuslan = document.getElementById("betalaHuslan").checked;
    let f√∂rs√§ljningspris = nuvarde * multipel;
    let exitKapital = f√∂rs√§ljningspris;

    let skattL√•g = 0.20;
    let skattH√∂g = 0.50;

    /* 3:12-l√•g/h√∂g f√∂r husl√•net */
    let nettolag = userGransvarde312 * (1 - skattL√•g);
    let l√•nebehEfterL√•gSkatt = huslan - nettolag;
    let bruttoH√∂gBehov = l√•nebehEfterL√•gSkatt / (1 - skattH√∂g);
    let totaltBruttoF√∂rL√•n = userGransvarde312 + bruttoH√∂gBehov;

    if(betalaHuslan) {
      exitKapital -= totaltBruttoF√∂rL√•n;
    }

    /* Bygg exit-ruta */
    let html = `<div class="box">`;
    if(betalaHuslan) {
      html += `
        <p class="result-title">Exitbelopp efter husl√•nsbetalning üè°</p>
        <p><strong>${formatNumber(exitKapital)}</strong></p>
        <p>
          Husl√•n: 
          <span class="link-like" onclick="openOverlayHuslan()">
            ${huslan.toLocaleString("sv-SE")}
          </span>
        </p>
        <p><strong>${formatNumber(exitKapital)}</strong></p>
        <p><strong>Bruttobelopp f√∂r l√•n:</strong> ${formatNumber(totaltBruttoF√∂rL√•n)}</p>
        <p>
          - 
          <span class="link-like" onclick="openOverlay312()">
            ${userGransvarde312.toLocaleString("sv-SE")} 
          </span>
          (20%):
          ‚Üí Netto: ${formatNumber(nettolag)}
        </p>
        <p>
          - Resterande (50%): 
          ${formatNumber(bruttoH√∂gBehov)} 
          ‚Üí Netto: 
          ${formatNumber(l√•nebehEfterL√•gSkatt)}
        </p>
      `;
    } else {
      html += `
        <p class="result-title">Exitbelopp</p>
        <p><strong>${formatNumber(exitKapital)}</strong></p>
      `;
    }
    html += `</div>`;
    document.getElementById("resultF√∂rs√§ljning").innerHTML = html;

    /* Utdelning */
    let avkastningProcent = parseInt(document.getElementById("avkastning").value, 10);
    document.getElementById("avkastningValue").textContent = avkastningProcent + "%";
    let avkastning = avkastningProcent / 100;

    let totalAvkastningJust = exitKapital * avkastning;
    let totalAvkastningOjust = f√∂rs√§ljningspris * avkastning;

    // IBB => Inom gr√§ns
    let gransvarde = ibb * 2.75;

    let utdJust = ber√§knaUtdelning(totalAvkastningJust, gransvarde, skattL√•g, skattH√∂g);
    let utdOjust = ber√§knaUtdelning(totalAvkastningOjust, gransvarde, skattL√•g, skattH√∂g);
    let skillnad = utdOjust.totalNetto - utdJust.totalNetto;

    document.getElementById("brutto").textContent = formatNumber(totalAvkastningJust);
    document.getElementById("inomGransvardeBrutto").textContent = formatNumber(utdJust.bruttoL√•g);
    document.getElementById("inomGransvardeNetto").textContent = formatNumber(utdJust.nettoL√•g);
    document.getElementById("overGransvardeBrutto").textContent = formatNumber(utdJust.bruttoH√∂g);
    document.getElementById("overGransvardeNetto").textContent = formatNumber(utdJust.nettoH√∂g);
    document.getElementById("totaltNetto").textContent = formatNumber(utdJust.totalNetto);

    /* Om husl√•n bockad -> skillnadsruta */
    let utdHuslanDiv = document.getElementById("utdelningHuslan");
    if(betalaHuslan) {
      utdHuslanDiv.style.display = "block";
      document.getElementById("utdelningOjust").textContent = formatNumber(utdOjust.totalNetto);
      document.getElementById("utdelningSkillnad").textContent = formatNumber(skillnad);
    } else {
      utdHuslanDiv.style.display = "none";
    }
  }

  /* St√§ng popups vid klick i overlay */
  function closeOverlayHuslan() {
    document.getElementById("overlayHuslan").style.display = "none";
  }
  function closeOverlay312() {
    document.getElementById("overlay312").style.display = "none";
  }
  function closeOverlayIBB() {
    document.getElementById("overlayIBB").style.display = "none";
  }

</script>
</body>
</html>
